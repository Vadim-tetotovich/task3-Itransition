<template>
    <div class="dynamic-table" v-if="tableShow">
        <el-table
            ref="table"
            v-loading.body="tableOption.loading"
            :element-loading-text="tableOption.loadingText"
            :stripe="tableOption.stripe"
            :border="tableOption.border"
            :fit="tableOption.fit"
            :show-header="tableOption.showHeader"
            :highlight-current-row="tableOption.highlightCurrent"
            :current-row-key="tableOption.currentRowKey"
            :row-class-name="tableOption.rowClassName"
            :row-style="tableOption.rowStyle"
            :empty-text="tableOption.emptyText"
            :default-expand-all="tableOption.defaultExpandAll"
            :expand-row-keys="tableOption.expandRowKeys"
            :default-sort="tableOption.defaultSort"
            :tooltip-effect="tableOption.tooltipEffect"
            :show-summary="tableOption.showSummary"
            :sum-text="tableOption.sumText"
            :summary-method="tableOption.summaryMethod"
            :data="rowList"
            :height="(tableOption && tableOption.height) || null"
            :max-height="(tableOption && tableOption.maxHeight) || null"
            @sort-change="handleSortChange"
            @row-click="handleRowClick"
            @row-dblclick="handleRowDbclick"
            @cell-click="handleCellClick"
            @cell-dblclick="handleCellDbclick"
            @cell-mouse-enter="handleCellMouseEnter"
            @cell-mouse-leave="handleCellMouseLeave"
            @header-click="handleHeaderClick"
            @header-dragend="handleHeaderGragend"
            @current-change="handleCurrentChange"
            @expand="handleExpand"
            @selection-change="handleSelectionChange">
            <el-table-column
                v-for="(headerItem, index) in columnOptions"
                v-if="headerItem.type === 'checkbox' && headerItem.show !== false"
                type="selection"
                :fixed="headerItem.fixed || null"
                :width="headerItem.width || 55"
                :key="index">
            </el-table-column>
            <el-table-column
                v-if="headerItem.type !== 'checkbox' && headerItem.show !== false"
                v-for="(headerItem, index) in columnOptions"
                :type="(headerItem.type === 'component' && headerItem.expand) ? 'expand' : null"
                :fixed="headerItem.fixed"
                :width="headerItem.width || null"
                :min-width="headerItem.minWidth || null"
                :prop="headerItem.prop || null"
                :label="headerItem.label || null"
                :key="headerItem.prop"
                :sortable="headerItem.sortable"
                :align="headerItem.align || 'left'"
                :sort-method="headerItem.sortMethod"
                :show-overflow-tooltip="headerItem.showOverflowTooltip || false">
                <template scope="scope" v-if="headerItem.type !== 'checkbox'">
                    <table-cell
                        :class="headerItem.columnClass"
                        v-if="headerItem.prop !== '$index'"
                        :forebearInstance="parentInstance"
                        :index="index"
                        :row="scope.row"
                        :perColumnOption="headerItem">
                    </table-cell>
                    <span v-if="headerItem.prop === '$index'">
                        {{scope.row.$index}}
                    </span>
                </template>
            </el-table-column>
        </el-table>
        <div class="dt-pagination" v-if="pagination.show !== false" :class="{'align-left': pagination.align === 'left', 'align-center': pagination.align === 'center', 'align-right': pagination.align === 'right'}">
            <el-pagination
                @current-change="handlePageChange"
                @size-change="handleSizeChange"
                :current-page="pagination.currentPage"
                :page-size="pagination.pageSize"
                :layout="pagination.layout || 'total, prev, pager, next'"
                :total="pagination.total"
                :page-sizes="pagination.pageSizes"
                :small="pagination.small">
            </el-pagination>
        </div>
    </div>
</template>

<script>

import tableCell from './table-cell';

export default {
    name: 'dynamic-table',
    data () {
        return {
            tableShow: true,
            parentInstance: null
        };
    },
    props: {
        'checkboxSelected': {
            type: Array,
            default: () => []
        },
        'tableOption': {
            type: Object,
            default: () => {
                return {};
            }
        },
        'columnOptions': {
            type: Array,
            default: () => []
        },
        'rowList': {
            type: Array,
            default: () => []
        },
        'pagination': {
            type: Object,
            default: () => {
                return {
                    show: false,
                    currentPage: 1,
                    pageSize: 10,
                    total: 100,
                    align: 'left'
                };
            }
        },
        'totalPage': {
            type: Number,
            default: 100
        }
    },
    watch: {
        rowList: {
            handler: function () {
                if (this.rowList.length) {
                    this.rowList.map((item, index) => {
                        item.$index = index + 1;
                    });
                    this.$nextTick(() => {
                        this.updateCheckboxSelectedList();
                    });
                }
            },
            deep: true
        },
        columnOptions: {
            handler: function (n, o) {
                if (JSON.stringify(n) === JSON.stringify(o)) {
                    return;
                }
                this.tableShow = false;
                this.$nextTick(() => {
                    this.tableShow = true;
                });
            },
            deep: true
        },
        checkboxSelected: {
            handler: function () {
                this.updateCheckboxSelectedList();
            },
            deep: true
        },
        totalPage () {
            this.pagination.total = this.totalPage;
        }
    },
    methods: {
        handlePageChange (val) {
            this.$emit('pageChange', val);
        },
        handleSizeChange (val) {
            this.$emit('sizeChange', val);
        },
        /**
         * 提供 element table 的 clearSelection 方法
         * @param selection
         */
        clearSelection (selection) {
            this.$refs.table.clearSelection(selection)
        },
        /**
         * 提供 element table 的 toggleRowSelection 方法
         * @param row
         * @param selected
         */
        toggleRowSelection (row, selected) {
            this.$refs.table.toggleRowSelection(row, selected)
        },
        handleRowClick () {
            this.$emit('row-click', ...arguments);
        },
        handleRowDbclick () {
            this.$emit('row-dbclick', ...arguments);
        },
        handleCellClick () {
            this.$emit('cell-click', ...arguments);
        },
        handleCellDbclick () {
            this.$emit('cell-dblclick', ...arguments);
        },
        handleHeaderClick () {
            this.$emit('header-click', ...arguments);
        },
        handleHeaderGragend () {
            this.$emit('header-dragend', ...arguments);
        },
        handleCurrentChange () {
            this.$emit('current-change', ...arguments);
        },
        handleExpand () {
            this.$emit('expand', ...arguments);
        },
        handleCellMouseEnter () {
            this.$emit('cell-mouse-enter', ...arguments);
        },
        handleCellMouseLeave () {
            this.$emit('cell-mouse-leave', ...arguments);
        },
        handleSortChange (obj) {
            this.$emit('sort-change', ...arguments);
        },
        /**
         * todo
         * 转发 element table 的事件
         * @param action
         * @returns {Function}
         */
        handleEvent (action) {
            const _self = this;
            // console.log('action name:', action);
            return function (){
                // console.log('emit');
                _self.$emit(action, ...arguments);
            };
        },
        handleSelectionChange (rows) {
            this.$emit('checkboxSelectChange', rows);
        },
        updateCheckboxSelectedList () {
            if (this.checkboxSelected.length) {
                // let rows = [];
                let length = this.rowList.length;
                this.checkboxSelected.forEach((item) => {
                    if (item <= length && item > 0) {
                        if (this.$refs.table) {
                            this.$refs.table.toggleRowSelection(this.rowList[item-1]);
                        }
                        if (this.$refs.multipleTable) {
                            this.$refs.multipleTable.toggleRowSelection(this.rowList[item-1]);
                        }
                    }
                });
            } else {
                if (this.$refs.table) {
                    this.$refs.table.clearSelection();
                }
                if (this.$refs.multipleTable) {
                    this.$refs.multipleTable.clearSelection();
                }
            }
        }
    },
    components: {
        tableCell
    },
    mounted () {
        this.parentInstance = this.tableOption.instance ? this.tableOption.instance : this.$parent;
        this.updateCheckboxSelectedList();
        this.$nextTick(() => {
            let table = null
            if (this.$refs.table) {
                table = this.$refs.table;
            }
            if (this.$refs.multipleTable) {
                table = this.$refs.multipleTable;
            }
            this.parentInstance._table = table;
        });
    }
};
</script>

<style>
.dynamic-table .dt-pagination {
    margin: 20px auto;
}
.dynamic-table .el-pagination {
    display: inline-block;
}
.vm {
    vertical-align: middle;
    display: inline-block;
}
.font-color {
    color: #333;
    font-weight: normal;
}
.dynamic-table .align-left {
    text-align: left;
}
.dynamic-table .align-center {
    text-align: center;
}
.dynamic-table .align-right {
    text-align: right;
}
.dynamic-table .mr5 {
    margin-right: 5px;
}
.dynamic-table .mbt3 {
    margin-top: 3px;
    margin-bottom: 3px;
}
.dynamic-table .mr7 {
    margin-right: 7px;
}
.dynamic-table .mtb3 {
    margin-top: 3px;
    margin-bottom: 3px;
}
.dynamic-table .fwn {
    font-weight: normal;
}
a {
    color: #337ab7;
    text-decoration: none;
}
</style>
